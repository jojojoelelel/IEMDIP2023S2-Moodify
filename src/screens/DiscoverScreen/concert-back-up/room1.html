<!--Sky Full of Stars by Coldplay-->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>A-Frame Scene with Audio Visualizer and Animated Model</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="js/aframe-spe-particles-component.js"></script>
    <script src="js/aframe-sprite-particles-component.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.4.0/dist/aframe-extras.min.js"></script>
    <!-- Import Map for Three.js and its modules -->
    <script type="importmap">
      {
        "imports": {
          "three": "https://cdn.jsdelivr.net/npm/three@0.137.5/build/three.module.js",
          "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.137.5/examples/jsm/"
        }
      }
    </script>
  </head>
  <body>
    <a-scene>
      <a-assets>
        <audio
          id="bg-music"
          src="./sounds/SkyFullOfStars.mp3"
          preload="auto"></audio>
        <img id="coldplay-bg" src="./img/room1sky.jpg" />
        <img id="bubblestar" src="./img/bubblestar.png" />
        <a-asset-item
          id="skeleton"
          response-type="arraybuffer"
          src="./models/skeleton_grup.glb"></a-asset-item>
        <a-asset-item
          id="concertstage"
          response-type="arraybuffer"
          src="./models/concert_stage2.glb">
        </a-asset-item>
      </a-assets>

      <a-sky src="#coldplay-bg"></a-sky>
      <a-entity
        spe-particles="
        texture: img/bubblestar.png; 
        color: #ccc; 
        blending: normal; 
        position-spread: 50 10 50; 
        radius: 0; 
        randomize-position: true; 
        particle-count: 8000; 
        velocity: 1 .5 1; 
        velocity-spread: .7 .9 .5; 
        wiggle-spread: 1 0 1; 
        maxAge: 100; 
        emitter-scale: 200
        angle-spread: 10 2 10;"></a-entity>

      <!-- Models -->

      <a-entity
        gltf-model="./models/skeleton_grup.glb"
        position="-0.28 0.828 -4.8966"
        scale="10 10 10"
        rotate="0 -30 0"
        animation-mixer="clip: Take 001; loop: infinite"
        rotation="0 28 0"
        visible=""></a-entity>

      <a-entity
        spe-particles="texture: img/bubblestar.png; color: #ccc; radius: 0; velocity: 1 0.5 1; maxAge: 100; positionSpread: 50 10 50; randomizePosition: true; particleCount: 8000; velocitySpread: 0.7 0.9 0.5; wiggleSpread: 1; emitterScale: 200"></a-entity>

      <a-entity
        gltf-model="./models/concert_stage2.glb"
        position="-0.28 0.4124 -5.26666"
        scale="0.08 0.08 0.08"
        rotate="0 -30 0"
        light="angle: -52.17; color: #c8b1b1; decay: -28.68; distance: 59.72; intensity: 2.94; type: point; shadowBias: 0.99; shadowCameraFar: 496.43; shadowCameraFov: 90.75; shadowCameraNear: 1.59; shadowCameraTop: 4.45; shadowCameraRight: 6.41; shadowCameraBottom: -2.6; shadowCameraLeft: -4.21; shadowMapHeight: 510.6; shadowMapWidth: 510.5; shadowRadius: -0.01"
        s=""
        visible=""></a-entity>

      <!-- Visualizer Plane -->

      <a-plane
        id="visualizer"
        position="0.11282 10.49032 -14.49377"
        rotation="0 5 0"
        scale="2 2 2"
        width="30"
        height="18"
        color="#FFC0CB"
        material="emissive: #000000"
        geometry="primitive: sphere"></a-plane>

      <!-- Camera -->
      <a-camera></a-camera>
    </a-scene>

    <script>
      document.addEventListener('DOMContentLoaded', function () {
        var models = document.querySelectorAll('a-entity[gltf-model]');
        models.forEach(model => {
          model.addEventListener('model-loaded', () => {
            console.log(
              'Model has been loaded successfully:',
              model.getAttribute('gltf-model'),
            );
          });
          model.addEventListener('loaded', () => {
            console.log(
              'Entity has been attached successfully:',
              model.getAttribute('gltf-model'),
            );
          });
          model.addEventListener('error', e => {
            console.error(
              'Error loading model',
              model.getAttribute('gltf-model'),
              e.detail,
            );
          });
        });
      });

      document.body.addEventListener('click', () => {
        var audio = document.querySelector('#bg-music');
        var visualizerPlane = document.querySelector('a-plane');
        if (!audio.isPlaying) {
          audio.play();
          audio.isPlaying = true;

          // Setup the audio context only after user interaction
          var audioContext = new AudioContext();
          var analyser = audioContext.createAnalyser();
          var source = audioContext.createMediaElementSource(audio);
          source.connect(analyser);
          analyser.connect(audioContext.destination);

          var dataArray = new Uint8Array(analyser.frequencyBinCount);
          var canvas = document.createElement('canvas');
          canvas.width = 256;
          canvas.height = 256;
          var ctx = canvas.getContext('2d');

          // Update the visualizer each frame
          function updateVisualizer() {
            requestAnimationFrame(updateVisualizer);
            analyser.getByteFrequencyData(dataArray);

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            for (var i = 0; i < dataArray.length; i++) {
              var barHeight = dataArray[i];
              var r = barHeight + 25 * (i / dataArray.length);
              var g = 250 * (i / dataArray.length);
              var b = 50;
              ctx.fillStyle = `rgb(${r},${g},${b})`;
              ctx.fillRect(
                i * (canvas.width / dataArray.length),
                canvas.height - barHeight,
                canvas.width / dataArray.length,
                barHeight,
              );
            }

            // Set the canvas as the texture for the plane
            var texture = new THREE.Texture(canvas);
            texture.needsUpdate = true;
            visualizerPlane.getObject3D('mesh').material.map = texture;
            visualizerPlane.getObject3D('mesh').material.needsUpdate = true;
          }

          updateVisualizer();
        }
      });

      //   Script for camera
      var sceneEl = document.querySelector('a-scene');
      var cameraEl = document.getElementById('rotating-camera');
      var radius = 10;
      var angle = 0;

      sceneEl.addEventListener('loaded', function () {
        setInterval(function () {
          angle += 0.01;
          var x = radius * Math.cos(angle);
          var z = radius * Math.sin(angle);
          cameraEl.setAttribute('position', {x: x, y: 1.6, z: z});
          cameraEl.setAttribute('rotation', {
            x: 0,
            y: angle * (180 / Math.PI) + 90,
            z: 0,
          });
        }, 10);
      });
    </script>
  </body>
</html>

<!--This work is based on "Solar Eclipse 2024" (https://sketchfab.com/3d-models/solar-eclipse-2024-357e6b38d74b414aae11cf9d948251fd) by tamminen (https://sketchfab.com/tamminen) licensed under CC-BY-4.0 (http://creativecommons.org/licenses/by/4.0/)-->
